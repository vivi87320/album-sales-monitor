import requests
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
import time
import traceback

# ===== ä½¿ç”¨è€…è¨­å®š =====
SHEET_ID = "1CIsh1bN92x7DlgHdsfohA2cJk13f5a-lWz2egVonYlk"
JSON_CREDENTIALS_FILE = "credentials.json"

CHECK_INTERVAL = 180          # æ¯ 3 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
FORCE_WRITE_INTERVAL = 3600   # æ¯ 1 å°æ™‚å¼·åˆ¶å¯«å…¥ä¸€æ¬¡ï¼ˆç§’ï¼‰

# === å•†å“ ===
API_URL = "https://www.kmonstar.com.tw/products/%E6%87%89%E5%8B%9F-260111-ive-the-4th-ep-ive-secret-%E5%B0%88%E8%BC%AF%E7%99%BC%E8%A1%8C%E7%B4%80%E5%BF%B5%E8%A6%96%E8%A8%8A%E7%B0%BD%E5%90%8D%E6%9C%83.json"
SHEET_NAME = "260111IVEè¦–è¨Š"

HEADERS = {
    "User-Agent": "Mozilla/5.0",
    "Referer": "https://www.kmonstar.com.tw/"
}

# ---- Google Sheets èªè­‰ ----
scope = [
    "https://spreadsheets.google.com/feeds",
    "https://www.googleapis.com/auth/drive"
]
creds = ServiceAccountCredentials.from_json_keyfile_name(
    JSON_CREDENTIALS_FILE, scope
)
client = gspread.authorize(creds)
worksheet = client.open_by_key(SHEET_ID).worksheet(SHEET_NAME)

# ---- æŠ“ inventory_quantity ----
def fetch_inventory(url):
    r = requests.get(url, headers=HEADERS, timeout=20)
    r.raise_for_status()
    data = r.json()

    quantities = []
    titles = []

    for v in data.get("variants", []):
        titles.append(v.get("title", "ç„¡å"))
        quantities.append(v.get("inventory_quantity"))

    return quantities, titles

# ---- å¯«å…¥é‚è¼¯ ----
def log_inventory(last_values, last_force_time):
    now_str = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    now_ts = time.time()

    try:
        quantities, titles = fetch_inventory(API_URL)

        # å»ºç«‹è¡¨é ­
        if worksheet.cell(1, 1).value != "æ™‚é–“":
            worksheet.append_row(["æ™‚é–“"] + titles)

        force_write = now_ts - last_force_time >= FORCE_WRITE_INTERVAL

        if last_values is None or quantities != last_values or force_write:
            worksheet.append_row([now_str] + quantities)
            print(f"[{now_str}] âœ… å¯«å…¥ï¼š{quantities}")
            return quantities, now_ts
        else:
            print(f"[{now_str}] â³ ç„¡è®Šå‹•")

    except Exception as e:
        print(f"[{now_str}] âŒ éŒ¯èª¤ï¼š{e}")
        traceback.print_exc()

    return last_values, last_force_time

# ---- ä¸»ç¨‹å¼ ----
if __name__ == "__main__":
    print("ğŸš€ å•Ÿå‹•ç›£æ¸¬ï¼ˆ3åˆ†é˜æª¢æŸ¥ / 1å°æ™‚å¼·åˆ¶å¯«å…¥ï¼‰")

    last_values = None
    last_force_time = time.time() - FORCE_WRITE_INTERVAL

    while True:
        last_values, last_force_time = log_inventory(
            last_values, last_force_time
        )
        time.sleep(CHECK_INTERVAL)
